---
title: "Enfermedades cardiovasculares y el tiempo"
author: "Nuria Martinez y Alba Sanz"
date: "2022-11-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Objetivos
##Relación comunidades autónomas con defunción por enfermedades cardiacas
##Relación temeperaturas máx y mín por Comuniades
##relación entre las dos anteriores

# Relación comunidades autónomas con defunción por enfermedades cardiacas

```{r include = FALSE }
library(readr)
enf_cardio2_0 <- read_delim("INPUT.DATA/enf_cardio2.0.csv", 
                            delim = ";", escape_double = FALSE, trim_ws = TRUE)

library(dplyr)
datos <- select(enf_cardio2_0, 'Causa de defunción', 'Comunidades y Ciudades Autónomas', 'Periodo', 'Total')

colnames(datos) <- c ('Causa_Defuncion' , 'Comunidades' , 'fecha' , 'Total')

library(tidyverse)
```


Para poder ver si existe cierta relación entre las comunidades autónomas y muertes por enfermedades cardiovasaculares, hemos cogido los datos con respecto a los años 2018, 2019 y 2020 y hemos creado un gráfico de barras.

```{r echo=TRUE}
gr_barras <- ggplot(datos, aes( x= Comunidades, y = Total))+
  geom_bar(aes(fill=factor(fecha)), stat = 'identity', position = 'dodge')+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```
```{r gr_barras, echo = FALSE}
plot(gr_barras)

```

Aparte, en la págine INE, de donde veinen los datos, hemos cogido las imágenes del mapa de España con respecto a cada año teniendo una idea más visual geográficamente de los cambios q ha habido

<div>
<p style = 'text-align:center;'>
<img src="./Input_images/mapa2018.png" alt="Mapa 2018">
</p>
</div>


**Conclusión** Se puede observar que ha habido un incremento de muertes en la zona sur y centro oeste mientras que en la zona noreste se aprecia una disminución

## R Markdown



#Relación temeperaturas máx y mín por Comuniades

```{r include = FALSE}
library(remotes)
#install_github("ropenspain/climaemet")
library(climaemet)
#aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJubXExMDAxQGFsdS51YnUuZXMiLCJqdGkiOiJlOWRmMTc0OC05NjcxLTRiMjctODM2OS01NmYxNTZjNjNjYzIiLCJpc3MiOiJBRU1FVCIsImlhdCI6MTY2NjE2NzExNCwidXNlcklkIjoiZTlkZjE3NDgtOTY3MS00YjI3LTgzNjktNTZmMTU2YzYzY2MyIiwicm9sZSI6IiJ9.mIlOZxnREIqfi6hTeh37A_yMnryWyI0NPJzilMMAMmU", install = TRUE)

stations <- aemet_stations() # Need to have the API Key registered

knitr::kable(head(stations))

data_observation <- aemet_last_obs("all")
data_observation
summary(data_observation)

data_daily <- aemet_daily_period_all(start = 2018, end = 2020) 
data_daily

tablaComunidades <- data_daily %>% 
  mutate(ComunidadesAutónomas = 
           case_when(provincia %in% c("BARCELONA", "TARRAGONA", "GIRONA","LLEIDA") ~ 'CATALUÑA', 
                     provincia %in% c("BURGOS", "SORIA", "SALAMANCA", "LEON","AVILA","PALENCIA","SEGOVIA","VALLADOLID","ZAMORA") ~ 'CyL',
                     provincia %in% c("ASTURIAS") ~ 'ASTURIAS',
                     provincia %in% c("A CORUÑA","LUGO","OURENSE","PONTEVEDRA") ~ 'GALICIA',
                     provincia %in% c("BIZKAIA","GIPUZKOA","ARABA/ALAVA") ~ 'PAIS VASCO',
                     provincia %in% c("CANTABRIA") ~ 'CANTABRIA',
                     provincia %in% c("NAVARRA") ~ 'NAVARRA',
                     provincia %in% c("MADRID") ~ 'MADRID',
                     provincia %in% c("CACERES","BADAJOZ") ~ 'EXTREMADURA',
                     provincia %in% c("CUENCA","GUADALAJARA","TOLEDO","CIUDAD REAL","ALBACETE") ~ 'CLM',
                     provincia %in% c("CORDOBA","HUELVA","CADIZ","GRANADA","JAEN","SEVILLA","ALMERIA","MALAGA") ~ 'ANDALUCIA',
                     provincia %in% c("MELILLA") ~ 'MELILLA',
                     provincia %in% c("ALICANTE","CASTELLON","VALENCIA") ~ 'VALENCIA',
                     provincia %in% c("MURCIA") ~ 'MURCIA',
                     provincia %in% c("TERUEL","HUESCA","ZARAGOZA") ~ 'ARAGON',
                     provincia %in% c("LA RIOJA") ~ 'LA RIOJA',
                     provincia %in% c("ILLES BALEARS") ~ 'ISLAS BALEARES',
                     provincia %in% c("LAS PALMAS","STA. CRUZ DE TENERIFE") ~ 'ISLAS CANARIAS',
                     provincia %in% c("CEUTA") ~ 'CEUTA',
                     
                     
                     
           ))


#install.packages('lubridate',dependencies=TRUE)
library(lubridate)

fecha2018 <- select(filter(tablaComunidades, year(tablaComunidades$fecha)==2018 ), ComunidadesAutónomas, fecha,tmax,tmin)

tmax2018<-aggregate(tmax~ComunidadesAutónomas, data=fecha2018, mean)
tmin2018<-aggregate(tmin~ComunidadesAutónomas, data=fecha2018, mean)
tmaxmin2018<-merge(x = tmax2018, y = tmin2018)

tabla2018 <- cbind(tmaxmin2018,fecha=c(2018))

fecha2019 <- select(filter(tablaComunidades, year(tablaComunidades$fecha)==2019 ), ComunidadesAutónomas, fecha,tmax,tmin)

tmax2019<-aggregate(tmax~ComunidadesAutónomas, data=fecha2019, mean)
tmin2019<-aggregate(tmin~ComunidadesAutónomas, data=fecha2019, mean)
tmaxmin2019<-merge(x = tmax2019, y = tmin2019)

tabla2019 <- cbind(tmaxmin2019,fecha=c(2019))

fecha2020 <- select(filter(tablaComunidades, year(tablaComunidades$fecha)==2020 ), ComunidadesAutónomas, fecha,tmax,tmin)

tmax2020<-aggregate(tmax~ComunidadesAutónomas, data=fecha2020, mean)
tmin2020<-aggregate(tmin~ComunidadesAutónomas, data=fecha2020, mean)
tmaxmin2020<-merge(x = tmax2020, y = tmin2020)

tabla2020 <- cbind(tmaxmin2020,fecha=c(2020))

tabla1819 = rbind(tabla2018, tabla2019)
tabladefinitiva = rbind(tabla1819, tabla2020)
```

Relacionando los datos de la temperatura máxima y mínima, mediante distintos gráficos, se puede observar como varía la temperatura en función de la comunidad autónoma.


```{r echo=TRUE}
  ggplot(data = tabladefinitiva, aes(x =ComunidadesAutónomas , y = tmax))+
  geom_point(aes(colour = fecha))+
  labs(x = "tmax", y = "ComunidadesAutónomas",title = 'Temperatura máxima por comunidad autonoma')+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```
En este primer gráfico de puntos, se observa la temperatura máxima por comunidad autónoma entre 2018 y 2020, y se puede ver que en muchas comunidades la temperatura máxima ha aumentado a lo largo del tiempo.

```{r echo=TRUE}
  ggplot(tabladefinitiva, aes(x = ComunidadesAutónomas, y = tmax )) +
  geom_bar(stat = 'identity', aes(fill = factor(fecha)), colour ='black',position = 'dodge') +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```

Como se ha comentado en el gráfico de puntos, con este gráfico de barras, efectivamnete se puede observar una subida de temperatura en todas las comunidades autónomas en 2019 y 2020 respecto a 2018


```{r echo=TRUE}
  ggplot(data = tabladefinitiva, aes(x =ComunidadesAutónomas , y = tmin))+
  geom_point(aes(colour = fecha))+
  labs(x = "tmax", y = "ComunidadesAutónomas",title = 'Temperatura mínima por comunidad autonoma')+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```
En este gráfico de puntos, se observa la temperatura minima por comunidad autónoma entre 2018 y 2020, y se puede ver que, existe mucha diferencia en la temperatura mínima entre unas comunidades y otras. A su vez, también se aprecia una subida de temperatura en prácticamente todas las comunidades en el último año.


```{r echo=TRUE}
  ggplot(tabladefinitiva, aes(x = ComunidadesAutónomas, y = tmin )) +
  geom_bar(stat = 'identity', aes(fill = factor(fecha)), colour ='black',position = 'dodge') +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```
Con este gráfico de barras de la temperatura mínima se puede corroborar lo dicho previamente con el de puntos ya que, se ve una mayor diferencia entre comunidades autónomas. También se aprecia que, la barra azul (la de 2020) es la más alta de las 3 en prácticamente todas las comunidades es decir, que en 2020 hubo un aumento de la temperatura mínima respecto al resto de años.

#Relación entre las dos anteriores

```{r echo = TRUE }
union <- merge(x = datos, y = tabladefinitiva, by=c('fecha', 'ComunidadesAutónomas'))


```


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
DT::datatable(union)
```



Para visualizar correctamente la relación entre enfermedades cardiovasculares y la temperatura por comunidades autónomas, se ha realizado la unión de ambas tablas (la temperatura y las enfermedades).
```{r echo=TRUE}
gr_max <-  ggplot(union, aes(x = tmax, y = Total))+
  geom_point(aes(colour=factor(ComunidadesAutónomas)))+
  geom_smooth(method= 'lm')+
  theme_bw()+
  facet_wrap(~fecha, nrow=1)
gr_max
```

Como se puede apreciar en este último gráfico, la relación que existe entre el total de defunciones por enfermedades cardiovasculares, la temperatura máxima y las comunidades autónomas para cada año, 




#poder cargar los datos si falla la página
```{r , echo=FALSE}
load("Input_objects/objetos_descargados.RData")
```
